<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Repair Portal Dashboard</title>
  <link rel="stylesheet" href="/css/admin/dashboard.css" />
</head>

<body>

  <!-- LOADER -->
  <div id="loader">
    <svg class="gear" viewBox="0 0 100 100">
      <path d="M94 56v-12l-8-3c-1-3-2-6-4-9l4-9-9-9-9 4c-3-2-6-3-9-4l-3-8h-12l-3 8c-3 1-6 2-9 4l-9-4-9 9 4 9c-2 3-3 6-4 9l-8 3v12l8 3c1 3 2 6 4 9l-4 9 9 9 9-4c3 2 6 3 9 4l3 8h12l3-8c3-1 6-2 9-4l9 4 9-9-4-9c2-3 3-6 4-9l8-3zM50 65a15 15 0 1 1 0-30 15 15 0 0 1 0 30z" />
    </svg>
  </div>

  <header class="header">
    <div class="theme-toggle">
      <span class="theme-icon">ðŸŒ™</span>
      <label class="switch">
        <input type="checkbox" id="themeToggle">
        <span class="slider round"></span>
      </label>
    </div>

    <h1>Repair Portal Dashboard</h1>

    <div class="user-actions">
      <span>Welcome, <%= user ? user.username : 'Admin' %></span>
      <form action="/admin/logout" method="POST" class="logout-form">
        <button type="submit" class="btn-logout" onclick="logoutWithAnimation('/admin/logout')">Logout</button>
      </form>
    </div>
  </header>

  <!-- Toolbar -->
  <section class="toolbar">
    <button type="button" id="btnAddJob">Add Job</button>
    <button type="button" id="btnSearchJob">Search Job</button>
  </section>

  <main class="content">

    <!-- ADD JOB FORM -->
    <section class="add-job" id="addJobForm">
      <h2>Add New Repair Job</h2>

      <% if (error) { %>
        <div class="error-message"><%= error %></div>
      <% } %>

      <form action="/admin/add-job" method="POST" class="add-job-form">
        <label>Customer Name: <input type="text" name="customerName" required /></label>
        <label>Phone Number: <input type="text" name="phoneNumber" required /></label>
        <label>VIN: <input type="text" name="vin" required /></label>
        <label>Make: <input type="text" name="make" required /></label>
        <label>Model: <input type="text" name="model" required /></label>
        <label>Year: <input type="text" name="year" required /></label>
        <label>Date Brought In: <input type="date" name="dateBroughtIn" required /></label>
        <button>Add Job</button>
      </form>
    </section>

    <!-- SEARCH JOB FORM -->
    <div class="page-content">
      <section class="search-job" id="searchJobForm" style="display:none;">
        <h2>Search Jobs</h2>
        <form action="/admin/search" method="GET" class="search-job-form">
          <label>Customer Name: <input type="text" name="customerName" /></label>
          <label>Phone Number: <input type="text" name="phoneNumber" /></label>
          <label>VIN: <input type="text" name="vin" /></label>
          <label>Status:
            <select name="status">
              <option value="">Any</option>
              <option value="Diagnostic">Diagnostic</option>
              <option value="In Progress">In Progress</option>
              <option value="Finishing Up">Finishing Up</option>
              <option value="Completed">Completed</option>
            </select>
          </label>
          <button type="submit">Search</button>
        </form>
      </section>

      <h2><%= searchMode ? "Search Results" : "Active Repairs" %></h2>

      <% if (searchMode) { %>
        <form action="/admin/dashboard" method="GET">
          <button type="submit" class="clear-search-btn">Clear Search</button>
        </form>
      <% } %>

      <% if (repairs && repairs.length > 0) { %>
        <table class="repairs-table">
          <thead>
            <tr>
              <th>Customer</th>
              <th>VIN</th>
              <th>Status</th>
              <th>Update</th>
              <th>Actions</th> <!-- VIEW + NOTES -->
            </tr>
          </thead>
          <tbody>
            <% repairs.forEach(repair => { %>
              <tr>
                <td><%= repair.customerName %></td>
                <td><%= repair.vin %></td>
                <td><%= repair.status %></td>

                <td>
                  <form action="/admin/job/<%= repair._id %>/update" method="POST">
                    <select name="status" onchange="this.form.submit()">
                      <option value="Diagnostic" <%= repair.status === 'Diagnostic' ? 'selected' : '' %>>Diagnostic</option>
                      <option value="In Progress" <%= repair.status === 'In Progress' ? 'selected' : '' %>>In Progress</option>
                      <option value="Finishing Up" <%= repair.status === 'Finishing Up' ? 'selected' : '' %>>Finishing Up</option>
                      <option value="Completed" <%= repair.status === 'Completed' ? 'selected' : '' %>>Completed</option>
                    </select>
                  </form>
                </td>

                <!-- ACTION BUTTONS -->
                <td class="action-buttons">
                  <button 
                    type="button"
                    class="view-btn"
                    data-customer="<%= repair.customerName %>"
                    data-phone="<%= repair.phoneNumber %>"
                    data-vin="<%= repair.vin %>"
                    data-make="<%= repair.make %>"
                    data-model="<%= repair.model %>"
                    data-year="<%= repair.year %>"
                    data-date="<%= repair.dateBroughtIn ? repair.dateBroughtIn.toLocaleDateString() : '' %>"
                    data-status="<%= repair.status %>"
                  >View</button>

                  <button 
                    type="button"
                    class="notes-btn"
                    data-id="<%= repair._id %>"
                  >Notes</button>
                  <a href="/admin/job/<%= repair._id %>/print" class="btn-print">Print</a>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>

      <% } else { %>
        <% if (searchMode) { %>
          <p>No matching repairs found.</p>
        <% } else { %>
          <p>No active repairs yet.</p>
        <% } %>
      <% } %>
    </div>
  </main>

  <!-- JOB DETAILS MODAL -->
  <div class="modal" id="jobModal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <h3>Job Details</h3>
      <p><strong>Customer:</strong> <span id="modalCustomer"></span></p>
      <p><strong>Phone:</strong> <span id="modalPhone"></span></p>
      <p><strong>VIN:</strong> <span id="modalVIN"></span></p>
      <p><strong>Make:</strong> <span id="modalMake"></span></p>
      <p><strong>Model:</strong> <span id="modalModel"></span></p>
      <p><strong>Year:</strong> <span id="modalYear"></span></p>
      <p><strong>Date Brought In:</strong> <span id="modalDate"></span></p>
      <p><strong>Status:</strong> <span id="modalStatus"></span></p>
    </div>
  </div>

  <!-- NOTES MODAL -->
  <div class="modal" id="notesModal">
    <div class="modal-content notes-content">
      <span class="close-btn" id="closeNotes">&times;</span>

      <h3>Repair Notes</h3>

      <div id="notesList"></div>

      <hr />

      <h4>Add / Edit Note</h4>
      <form id="notesForm" method="POST">
        <input type="hidden" id="noteId" name="noteId" />
        <input type="hidden" id="repairId" name="repairId" />

        <label>Description:
          <textarea id="noteDescription" name="description" required></textarea>
        </label>

        <label>Part:
          <input type="text" id="notePart" name="part" />
        </label>

        <label>Quantity:
          <input type="number" id="noteQuantity" name="quantity" min="1" value="1" />
        </label>

        <label>Price:
          <input type="number" id="notePrice" name="price" min="0" value="0" />
        </label>

        <button type="submit" class="btn-save-note">Save Note</button>
      </form>
    </div>
  </div>

  <!-- ANALYTICS -->
  <section class="analytics">
    <div class="stats-row">
      <div class="stat-card">Total Jobs: <%= stats.total %></div>
      <div class="stat-card">Active Jobs: <%= stats.active %></div>
      <div class="stat-card">Completed: <%= stats.completed %></div>
      <div class="stat-card">Diagnostic: <%= stats.diagnostic %></div>
    </div>

    <div class="chart-container">
      <h3>Repairs Per Month</h3>
      <canvas id="monthlyChart"></canvas>
    </div>

    <div class="chart-container">
      <h3>Status Breakdown</h3>
      <canvas id="statusChart"></canvas>
    </div>
  </section>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  // Data from server
  const monthlyData = <%- JSON.stringify(monthlyCounts) %>;
  const statusData = <%- JSON.stringify(statusCounts) %>;

  // Shared chart defaults (dark)
  Chart.defaults.color = '#cfe8ff';
  Chart.defaults.font.family = 'Inter, Arial, sans-serif';
  Chart.defaults.backgroundColor = 'rgba(255,255,255,0.02)';

  // Monthly Line Chart
  const ctxM = document.getElementById('monthlyChart').getContext('2d');
  new Chart(ctxM, {
    type: 'line',
    data: {
      labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
      datasets: [{
        label: 'Repairs Per Month',
        data: monthlyData,
        borderColor: '#3aa0ff',
        backgroundColor: 'rgba(58,160,255,0.08)',
        pointBackgroundColor: '#3ad9c4',
        fill: true,
        tension: 0.35,
        borderWidth: 2
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks:{ color:'#9fb8d9' } },
        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks:{ color:'#9fb8d9', beginAtZero:true } }
      },
      maintainAspectRatio: false
    }
  });

  // Status Doughnut Chart
  const ctxS = document.getElementById('statusChart').getContext('2d');
  new Chart(ctxS, {
    type: 'doughnut',
    data: {
      labels: Object.keys(statusData),
      datasets: [{
        data: Object.values(statusData),
        backgroundColor: ['#3aa0ff','#3ad9c4','#ffd166','#8b5cf6'],
        borderColor: 'rgba(0,0,0,0)',
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: { position: 'bottom', labels: { color: '#bcd8ff' } }
      },
      maintainAspectRatio: false,
      cutout: '55%'
    }
  });
</script>

<script>
// Reveal dashboard after loader finishes
window.addEventListener("load", () => {
  setTimeout(() => {
    document.querySelector(".page-content").classList.add("show");
  }, 1200);
});

// Logout animation (fade + blur before redirect)
function logoutWithAnimation(url) {
  document.querySelector(".page-content").classList.add("fade-out");
  setTimeout(() => {
    window.location.href = url;
  }, 300);
}
</script>

<script>
  // Load stored theme
  const savedTheme = localStorage.getItem("theme");
  const body = document.body;
  const toggle = document.getElementById("themeToggle");

  if (savedTheme === "dark") {
    body.classList.add("dark-mode");
    toggle.checked = true;
  }

  toggle.addEventListener("change", () => {
    if (toggle.checked) {
      body.classList.add("dark-mode");
      localStorage.setItem("theme", "dark");
    } else {
      body.classList.remove("dark-mode");
      localStorage.setItem("theme", "light");
    }
  });
</script>

  <!-- NOTES JS -->
  <script>
    document.querySelectorAll(".notes-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const repairId = btn.dataset.id;
        document.getElementById("repairId").value = repairId;

        // LOAD EXISTING NOTES
        const res = await fetch(`/admin/job/${repairId}/notes/json`);;
        const data = await res.json();

        const container = document.getElementById("notesList");
        container.innerHTML = "";

        if (data.length === 0) {
          container.innerHTML = "<p>No notes yet.</p>";
        } else {
          data.forEach(note => {
            container.innerHTML += `
              <div class="note-item">
                <p><strong>${note.description}</strong></p>
                <p>Part: ${note.part || "â€”"} | Qty: ${note.quantity} | $${note.price}</p>
                <button onclick="editNote('${note._id}', '${note.description}', '${note.part}', '${note.quantity}', '${note.price}')">Edit</button>
                <button onclick="deleteNote('${repairId}', '${note._id}')">Delete</button>
              </div>
            `;
          });
        }

        document.getElementById("notesModal").style.display = "block";
      });
    });

    function editNote(id, desc, part, qty, price) {
      document.getElementById("noteId").value = id;
      document.getElementById("noteDescription").value = desc;
      document.getElementById("notePart").value = part;
      document.getElementById("noteQuantity").value = qty;
      document.getElementById("notePrice").value = price;
    }

    async function deleteNote(repairId, noteId) {
      await fetch(`/admin/job/${repairId}/notes/${noteId}`, { method: "DELETE" });
      location.reload();
    }

    // SAVE NOTE
    document.getElementById("notesForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const repairId = document.getElementById("repairId").value;
      const noteId = document.getElementById("noteId").value;

      const payload = {
        description: document.getElementById("noteDescription").value,
        part: document.getElementById("notePart").value,
        quantity: document.getElementById("noteQuantity").value,
        price: document.getElementById("notePrice").value
      };

      const url = noteId
        ? `/admin/job/${repairId}/notes/${noteId}`   // EDIT
        : `/admin/job/${repairId}/notes`;           // NEW

      await fetch(url, {
        method: noteId ? "PUT" : "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      location.reload();
    });

    // CLOSE MODAL
    document.getElementById("closeNotes").addEventListener("click", () => {
      document.getElementById("notesModal").style.display = "none";
    });
  </script>

  <script src="/js/admin/dashboard.js"></script>
</body>
</html>